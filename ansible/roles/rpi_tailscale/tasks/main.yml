---
# roles/rpi_tailscale - Tailscale 安裝（互動式）

- name: Check if Tailscale is installed
  ansible.builtin.command: tailscale version
  register: tailscale_check
  changed_when: false
  failed_when: false
  tags: [tailscale]

- name: Install Tailscale
  ansible.builtin.shell: curl -fsSL https://tailscale.com/install.sh | sh
  when: tailscale_check.rc != 0
  tags: [tailscale]

- name: Check Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false
  when: tailscale_check.rc == 0
  tags: [tailscale]

- name: Show Tailscale status
  ansible.builtin.debug:
    msg: "{{ tailscale_status.stdout_lines | default(['Tailscale not yet configured']) }}"
  tags: [tailscale]

- name: Remind about Tailscale login
  ansible.builtin.pause:
    prompt: >
      如果 Tailscale 尚未登入，請在另一個終端執行：
      ssh {{ ansible_user }}@{{ ansible_host }} tailscale up --advertise-routes=192.168.88.0/24

      完成後按 Enter 繼續...
  when: tailscale_check.rc != 0
  tags: [tailscale]
