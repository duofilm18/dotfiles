---
# roles/rpi_mqtt_services - mqtt-led + mqtt-ntfy + systemd

# --- mqtt-led ---
- name: Create mqtt-led directory
  ansible.builtin.file:
    path: "{{ mqtt_led_dir }}"
    state: directory
    mode: "0755"
  tags: [mqtt, led]

- name: Deploy mqtt-led files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ mqtt_led_dir }}/{{ item.dest }}"
    remote_src: true
  loop:
    - { src: "{{ remote_dotfiles }}/rpi5b/mqtt-led/mqtt_led.py", dest: mqtt_led.py }
    - { src: "{{ remote_dotfiles }}/rpi5b/mqtt-led/requirements.txt", dest: requirements.txt }
  tags: [mqtt, led]

- name: Deploy mqtt-led config (example if no config exists)
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/mqtt-led/config.json.example"
    dest: "{{ mqtt_led_dir }}/config.json"
    remote_src: true
    force: false
  tags: [mqtt, led]

- name: Install mqtt-led requirements
  ansible.builtin.pip:
    requirements: "{{ mqtt_led_dir }}/requirements.txt"
    extra_args: --break-system-packages
  tags: [mqtt, led]

# --- mqtt-ntfy ---
- name: Create mqtt-ntfy directory
  ansible.builtin.file:
    path: "{{ mqtt_ntfy_dir }}"
    state: directory
    mode: "0755"
  tags: [mqtt, ntfy]

- name: Deploy mqtt-ntfy files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ mqtt_ntfy_dir }}/{{ item.dest }}"
    remote_src: true
  loop:
    - { src: "{{ remote_dotfiles }}/rpi5b/mqtt-ntfy/mqtt_ntfy.py", dest: mqtt_ntfy.py }
    - { src: "{{ remote_dotfiles }}/rpi5b/mqtt-ntfy/requirements.txt", dest: requirements.txt }
  tags: [mqtt, ntfy]

- name: Deploy mqtt-ntfy config (example if no config exists)
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/mqtt-ntfy/config.json.example"
    dest: "{{ mqtt_ntfy_dir }}/config.json"
    remote_src: true
    force: false
  tags: [mqtt, ntfy]

- name: Install mqtt-ntfy requirements
  ansible.builtin.pip:
    requirements: "{{ mqtt_ntfy_dir }}/requirements.txt"
    extra_args: --break-system-packages
  tags: [mqtt, ntfy]

# --- systemd services ---
- name: Deploy mqtt-led systemd service
  ansible.builtin.template:
    src: mqtt-led.service.j2
    dest: /etc/systemd/system/mqtt-led.service
    mode: "0644"
  notify: Reload and restart mqtt services
  tags: [mqtt, led, systemd]

- name: Deploy mqtt-ntfy systemd service
  ansible.builtin.template:
    src: mqtt-ntfy.service.j2
    dest: /etc/systemd/system/mqtt-ntfy.service
    mode: "0644"
  notify: Reload and restart mqtt services
  tags: [mqtt, ntfy, systemd]

- name: Enable mqtt services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - mqtt-led
    - mqtt-ntfy
  tags: [mqtt, systemd]

