---
# roles/rpi_system - 系統設定（boot, fstab, log2ram, sysctl, journald, MOTD）
# 用 synchronize 同步 rpi5b/ 到遠端，再用 remote_src 引用

- name: Sync rpi5b directory to remote
  ansible.posix.synchronize:
    src: "{{ dotfiles_local }}/rpi5b/"
    dest: "{{ remote_dotfiles }}/rpi5b/"
    delete: true
  become: false
  tags: [system, sync]

- name: Apply boot/config.txt
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/boot/config.txt"
    dest: /boot/firmware/config.txt
    remote_src: true
  tags: [system, boot]

- name: Ensure tmpfs /tmp in fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: "tmpfs /tmp tmpfs defaults,nosuid 0 0"
    regexp: "tmpfs /tmp"
    state: present
  tags: [system, fstab]

- name: Remind about fstab noatime,commit=3600
  ansible.builtin.debug:
    msg: >
      fstab 的根目錄掛載選項需手動加上 noatime,commit=3600。
      參考 rpi5b/system/etc/fstab.append
  tags: [system, fstab]

- name: Apply log2ram.conf (if installed)
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/etc/log2ram.conf"
    dest: /etc/log2ram.conf
    remote_src: true
  when: ansible_facts.services['log2ram.service'] is defined
  ignore_errors: true
  tags: [system, log2ram]

- name: Ensure vm.swappiness=100 in sysctl.conf
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "100"
    sysctl_file: /etc/sysctl.conf
    reload: true
  tags: [system, sysctl]

- name: Apply journald.conf
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/etc/systemd/journald.conf"
    dest: /etc/systemd/journald.conf
    remote_src: true
  notify: Restart journald
  tags: [system, journald]

- name: Apply armbian-ramlog (if exists)
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/etc/default/armbian-ramlog"
    dest: /etc/default/armbian-ramlog
    remote_src: true
  when: "'/etc/default/armbian-ramlog' is exists"
  ignore_errors: true
  tags: [system, armbian]

- name: Apply armbian-zram-config (if exists)
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/etc/default/armbian-zram-config"
    dest: /etc/default/armbian-zram-config
    remote_src: true
  when: "'/etc/default/armbian-zram-config' is exists"
  ignore_errors: true
  tags: [system, armbian]

- name: Apply MOTD service links
  ansible.builtin.copy:
    src: "{{ remote_dotfiles }}/rpi5b/system/etc/update-motd.d/36-services"
    dest: /etc/update-motd.d/36-services
    mode: "0755"
    remote_src: true
  tags: [system, motd]

