---
# roles/rpi_docker - Docker + docker-compose 服務

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: docker_check
  changed_when: false
  failed_when: false
  tags: [docker]

- name: Install Docker
  ansible.builtin.shell: curl -fsSL https://get.docker.com | sh
  when: docker_check.rc != 0
  tags: [docker]

- name: Ensure Docker is enabled and started
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started
  tags: [docker]

- name: Disable systemd-resolved (free port 53 for Pi-hole)
  ansible.builtin.systemd:
    name: systemd-resolved
    enabled: false
    state: stopped
  failed_when: false
  tags: [docker, pihole]

- name: Set static resolv.conf
  ansible.builtin.copy:
    content: "nameserver 1.1.1.1\n"
    dest: /etc/resolv.conf
  tags: [docker, pihole]

- name: Start Docker Compose services (uptime-kuma + ntfy + pihole)
  community.docker.docker_compose_v2:
    project_src: "{{ docker_compose_dir }}"
    state: present
  tags: [docker, compose]
